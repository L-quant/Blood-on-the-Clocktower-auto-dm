# Blood on the Clocktower Auto-DM — 前端重写需求文档

> 版本：v3.0 | 日期：2026-02-21
> 状态：待确认

---

## 一、项目概述

### 1.1 目标

彻底重写 Blood on the Clocktower Auto-DM 前端系统，从零设计全新的交互逻辑和用户体验。保留现有后端 API 契约（REST + WebSocket）和官方美术资产（角色图标、背景图、字体等），但所有 UI 组件、交互流程、状态管理逻辑均重新设计实现。

### 1.2 技术栈

| 层级 | 选型 | 理由 |
|------|------|------|
| 框架 | Vue 2.6 + Vuex 3 | 保持与现有构建工具链兼容 |
| 国际化 | Vue I18n 8 | 保持中英双语支持 |
| 样式 | SCSS + CSS Variables | 支持主题切换和动态配色 |
| 图标 | FontAwesome | 已有依赖 |
| 构建 | Vue CLI 5 | 现有工具链 |
| WebSocket | 原生 WebSocket | 轻量化，去除 ws 依赖 |

### 1.3 设计原则

1. **Mobile-First**：手机是主要使用场景（玩家拿着手机围坐一圈），所有界面优先为竖屏触控设计
2. **信息密度最小化**：每个界面只展示当前阶段必要的信息，隐藏无关内容
3. **零学习成本**：新玩家不需要教程就能完成基本操作（加入房间、查看角色、投票）
4. **沉浸感**：通过动画、音效、视觉层次营造暗黑奇幻氛围
5. **状态可感知**：游戏阶段、连接状态、自己的角色信息在任何时候一目了然
6. **座位号即身份**：没有用户名、没有注册登录。玩家通过座位号（1号、2号...）相互识别，与线下游戏体验一致

### 1.4 核心身份机制

**所有玩家以座位号作为唯一标识。** 这是与线下 BOTC 游戏一致的设计：

- 加入房间无需输入任何个人信息（无用户名、无头像、无注册）
- 玩家点击空座位即入座，获得该座位号（如「3号」）
- 游戏中所有交互均以座位号称呼（聊天、提名、投票、夜晚行动目标等）
- 座位号从 1 开始，顺时针排列
- 旁观者无座位号，仅以「旁观者」身份存在
- 前端通过 WebSocket 连接的 session token 区分身份，无需额外鉴权

---

## 二、用户角色定义

### 2.1 AI 说书人（Automated Storyteller）

说书人由后端 AI Agent 完全自动化，**没有任何人类说书人界面**。前端不需要魔典视图、ST 控制面板等 ST 专属 UI。AI Agent 负责：

- 自动分配角色（根据剧本和玩家数）
- 自动推进游戏阶段（夜晚→白天→提名→投票→循环）
- 自动执行夜晚唤醒流程（按夜晚行动顺序依次唤醒玩家）
- 自动处理角色能力结果（根据游戏规则计算并发送）
- 自动管理死亡、中毒等状态
- 通过系统消息与玩家沟通
- 自动判定游戏胜负

前端仅需：接收并展示 AI 说书人通过 WebSocket 推送的事件。

### 2.2 房主（Room Owner）

创建房间的玩家自动成为房主。房主**同时也是普通玩家**，在游戏中没有任何特权。房主在大厅阶段的额外权限：

- 选择剧本/版本
- 配置游戏参数（座位数等）
- 点击「开始游戏」
- 踢出玩家

游戏开始后，房主与其他玩家完全一致。

### 2.3 玩家（Player）

- 加入房间 → 点击空座位入座 → 获得座位号（如「3号」）
- 查看**仅自己的**角色卡（其他玩家角色不可见）
- 在圆环上**标记/猜测**其他座位的角色（个人笔记，仅自己可见）
- 白天讨论（公开聊天、悄悄话——通过座位号选择对象）
- 提名其他座位的玩家（白天阶段，每人每天限一次提名）
- 投票（被提名者投票时参与）
- 夜晚执行能力（通过座位号选择目标、接收 AI 说书人的信息）
- 死亡后保留一次幽灵投票
- 随时向 AI 助手提问（角色策略、游戏规则等）

### 2.4 旁观者（Spectator）

- 加入房间但不坐下（无座位号）
- 观看公开的镇广场视图（仅可见座位号和存活状态，不可见任何角色）
- 查看公开聊天
- 不能投票、不能使用能力、不能悄悄话
- 可以使用 AI 助手了解规则

---

## 三、全局界面架构

### 3.1 屏幕流转（Screen Flow）

```
┌─────────────┐
│   启动页     │  ← 品牌 Logo + 版本号，1.5s 自动跳转
│  (Splash)    │
└──────┬──────┘
       ▼
┌─────────────┐
│   首页       │  ← 两个主按钮：创建房间 / 加入房间
│  (Home)      │     底部：语言切换、设置入口
└──────┬──────┘
       ▼
┌─────────────┐
│   大厅       │  ← 等待玩家加入、选座、房主配置游戏
│  (Lobby)     │     准备就绪后房主（也是玩家）点击"开始游戏"
└──────┬──────┘
       ▼
┌─────────────────────────────────────────────┐
│              游戏主界面 (Game)                │
│  ┌─────────┬─────────┬─────────┬─────────┐  │
│  │镇广场   │  聊天    │ 时间线  │  我的    │  │
│  │(Square) │ (Chat)  │(Timeline)│ (Me)   │  │
│  └─────────┴─────────┴─────────┴─────────┘  │
│         ▲ 底部导航栏（手机端）                  │
│                                              │
│  覆盖层：                                     │
│  ├── 夜晚行动面板（全屏遮罩）                   │
│  ├── 投票面板（底部弹出）                       │
│  ├── 阶段切换动画（全屏遮罩）                   │
│  ├── 游戏结束画面（全屏遮罩）                   │
│  └── 角色详情弹窗                              │
└─────────────────────────────────────────────┘
```

### 3.2 全局固定元素

#### 顶部状态栏（Top Bar）— 48px 高

| 左侧 | 中间 | 右侧 |
|------|------|------|
| 连接状态指示灯（绿/黄/红） | 阶段标签 + 天数计数器 | 房间号 |
|  | 如："第 2 天 · 白天讨论" |  |

- 连接状态：绿色圆点 = 已连接，黄色闪烁 = 重连中，红色 = 断开
- 阶段标签随游戏进程自动更新
- 房间号可点击复制

#### 底部导航栏（Bottom Nav）— 56px 高（仅手机端显示）

4 个标签页：

| 图标 | 标签 | 功能 |
|------|------|------|
| 🏘 圆形图标 | 广场 | 镇广场/玩家圆环 |
| 💬 气泡图标 | 聊天 | 公开聊天 + 悄悄话 |
| 📜 卷轴图标 | 事件 | 游戏时间线/事件记录 |
| 👤 人物图标 | 我的 | 角色卡 + 个人设置 |

- 聊天标签显示未读消息红点
- 当前激活标签高亮
- 桌面端使用侧边栏布局替代底部导航

---

## 四、各屏幕详细设计

### 4.1 首页（Home Screen）

**布局：**
```
┌──────────────────────┐
│                      │
│     [BOTC Logo]      │
│  Blood on the        │
│  Clocktower          │
│                      │
│  ┌────────────────┐  │
│  │  创建房间       │  │  ← 主色调按钮，大号
│  └────────────────┘  │
│                      │
│  ┌────────────────┐  │
│  │  加入房间       │  │  ← 次色调按钮
│  └────────────────┘  │
│                      │
│  ┌────────────────┐  │
│  │  单人模式       │  │  ← 文字链接样式
│  └────────────────┘  │
│                      │
│  [中文/EN]  [设置⚙]  │  ← 底部工具栏
└──────────────────────┘
```

**交互：**
- 「创建房间」→ 调用 `POST /v1/rooms`，获取房间号后**直接进入大厅**（无需输入任何信息）
- 「加入房间」→ 弹出房间号输入面板（4-6 位字母数字），输入后调用 `POST /v1/rooms/{id}/join`，**直接进入大厅**
- 「单人模式」→ 进入 Bot 配置页（选择 Bot 数量和难度），然后启动本地模拟游戏
- URL hash `#roomCode` 自动触发加入流程
- 「设置」→ 滑出设置面板（音效开关、动画开关、语言切换、背景图选择）
- **全程无需注册、登录、输入用户名** — 进入房间后点击座位即获得身份

**房间号输入面板：**
- 从底部滑出的面板（Bottom Sheet 样式）
- 大号等宽字体输入框，自动大写
- 实时校验：格式错误显示红色边框 + 提示
- 输入完成自动提交（无需点击确认按钮）
- 支持粘贴

### 4.2 大厅（Lobby Screen）

**房主视角：**
```
┌──────────────────────┐
│ ● 已连接    大厅    AXKM │ ← 顶部状态栏，房间号可复制
├──────────────────────┤
│                      │
│  房间号: AXKM        │
│  [点击复制邀请链接]    │
│                      │
│  ── 座位 (4/8) ──    │
│  ┌──┐ ┌──┐ ┌──┐ ┌──┐│
│  │1号│ │2号│ │3号│ │4号│ ← 已有人坐下的座位
│  │⭐│ │ ● │ │ ● │ │ ● │   ⭐=你（房主）
│  └──┘ └──┘ └──┘ └──┘│
│  ┌──┐ ┌──┐ ┌──┐ ┌──┐│
│  │5号│ │6号│ │7号│ │8号│ ← 空座位（虚线边框，可点击入座）
│  │空 │ │空 │ │空 │ │空 │
│  └──┘ └──┘ └──┘ └──┘│
│                      │
│  旁观中: 2 人         │
│                      │
│  ── 游戏配置 ──      │
│  剧本: [Trouble Brewing ▼] │
│  座位数: [5-15 滑块]  │
│  预计阵营: 5镇民 1外来者 1爪牙 1恶魔 │
│                      │
│  ┌────────────────┐  │
│  │   开始游戏 ▶    │  │ ← 所有座位满后激活
│  └────────────────┘  │
└──────────────────────┘
```

**普通玩家视角：**
```
┌──────────────────────┐
│ ● 已连接    大厅    AXKM │
├──────────────────────┤
│                      │
│  等待房主开始游戏... │ ← 带脉冲动画
│                      │
│  ── 座位 (4/8) ──    │
│  ┌──┐ ┌──┐ ┌──┐ ┌──┐│
│  │1号│ │2号│ │3号│ │4号│
│  │ ● │ │ ● │ │⭐│ │ ● │  ⭐=你（3号座位）
│  └──┘ └──┘ └──┘ └──┘│
│  ┌──┐ ┌──┐ ┌──┐ ┌──┐│
│  │5号│ │6号│ │7号│ │8号│
│  │空 │ │空 │ │空 │ │空 │
│  └──┘ └──┘ └──┘ └──┘│
│                      │
│  剧本: Trouble Brewing│
│  当前 4/8 位玩家     │
│                      │
│  ┌────────────────┐  │
│  │   离开座位      │  │
│  └────────────────┘  │
└──────────────────────┘
```

**未入座状态（旁观者）：**
```
┌──────────────────────┐
│ ● 已连接    大厅    AXKM │
├──────────────────────┤
│                      │
│  点击空座位入座       │
│                      │
│  ── 座位 (4/8) ──    │
│  ┌──┐ ┌──┐ ┌──┐ ┌──┐│
│  │1号│ │2号│ │3号│ │4号│
│  │ ● │ │ ● │ │ ● │ │ ● │
│  └──┘ └──┘ └──┘ └──┘│
│  ┌──┐ ┌──┐ ┌──┐ ┌──┐│
│  │5号│ │6号│ │7号│ │8号│ ← 点击即可入座
│  │空 │ │空 │ │空 │ │空 │
│  └──┘ └──┘ └──┘ └──┘│
│                      │
│  剧本: Trouble Brewing│
│                      │
│  ┌────────────────┐  │
│  │   离开房间      │  │
│  └────────────────┘  │
└──────────────────────┘
```

**交互：**
- 入座：进入房间后为旁观者状态，点击任意空座位即入座，获得该座位号
- 换座：点击已入座的自己 → 确认后离座，然后可点击其他空座位换座
- 座位显示：已占座位显示实心圆点 ●，自己的座位显示 ⭐，空座位显示虚线边框
- 房主可拖拽调整座位上玩家的位置
- 房主选择剧本后自动显示阵营配比预览
- 所有座位满后「开始游戏」按钮激活（也可提前开始，最少 5 人）
- 新玩家入座时有入场动画 + 提示音
- 离开房间需二次确认

### 4.3 游戏主界面 — 镇广场（Town Square Tab）

**核心：玩家圆环**

这是游戏的核心视图。所有在座玩家排列成一个圆环，位于屏幕中央。

```
┌──────────────────────┐
│ ● 已连接  第1天·白天  AXKM│
├──────────────────────┤
│                      │
│         [8] [1]      │
│      [7]       [2]   │
│                      │
│     [6]         [3]  │
│                      │
│      [5]       [4]   │
│                      │
│                      │
│  ┌────────────────┐  │
│  │ 存活: 7  死亡: 1 │  │ ← 底部信息条（号=座位号）
│  └────────────────┘  │
├──────────────────────┤
│  广场  聊天  事件  我的 │ ← 底部导航
└──────────────────────┘
```

**玩家节点（Player Node）设计：**

每个玩家在圆环上显示为一个圆形节点。**核心规则：玩家只能看到自己的角色。**

| 状态 | 外观 |
|------|------|
| 自己（存活）| 自己的角色图标 + 阵营色边框 + 座位号 + "我" 标记 |
| 自己（死亡）| 角色图标变暗 + 裹尸布 + "幽灵投票" 标记 |
| 他人（未标记）| 灰色问号圆形 + 座位号（如「3号」）|
| 他人（已标记猜测）| **自己标记的**角色图标 + 虚线阵营色边框 + 座位号 |
| 他人（死亡）| 灰暗 + 裹尸布 + 座位号（游戏结束后揭示真实角色）|
| 被提名中 | 脉冲红色边框 + 座位号 |
| 自己（被提名中）| 脉冲红色边框 + 震动提示 |

**角色标记系统（个人笔记型）：**

玩家可以在圆环上标记自己对其他玩家角色的猜测，方便推理：

- 点击他人节点 → 弹出操作面板：
  - **标记角色**：从当前剧本的角色列表中选择一个角色标记到该玩家节点上
  - **标记阵营**：快捷标记善良/邪恶（不选具体角色）
  - **添加笔记**：为该玩家写一段文字备注
  - **清除标记**：移除所有标记
- 标记数据**仅存储在本地**（localStorage），其他玩家不可见
- 标记后的节点显示所标记的角色小图标（带半透明效果+虚线边框，与自己的实线边框区分）
- 同一玩家可多次修改标记

```
标记后的圆环示例（你坐在 1 号）：

          [?8号] [我·1号·洗衣妇]
    [?7号]                [?3号·厨师]  ← 你把3号标记为"厨师"
                                          虚线蓝色边框
   [?6号]                 [☠️4号]      ← 4号已死亡
    [5号·标·间谍]    [?2号]
     ↑ 你把5号标记为"间谍"
       虚线橙色边框
```

**交互：**
- 点击自己的节点 → 展开角色卡片快览
- 点击他人节点 → 弹出操作面板（座位号、存活状态、你的标记、笔记、操作按钮）
- 长按他人节点 → 快速发起悄悄话（如：与5号悄悄话）
- 双指缩放控制圆环大小
- 信息条显示存活/死亡计数，点击可展开详细列表
- **白天阶段**：操作面板中额外显示「提名此玩家」按钮（如果自己今天还没提名过）

### 4.4 游戏主界面 — 聊天（Chat Tab）

**频道系统：**

| 频道 | 可见者 | 触发条件 |
|------|--------|---------|
| 公开频道 | 所有人 | 默认频道 |
| 悄悄话 | 发送者 + 接收者 | 点击玩家头像发起 |
| 邪恶频道 | 爪牙 + 恶魔 | 邪恶阵营自动可见 |
| **AI 助手** | **仅自己** | **始终可用，独立频道** |
| 系统消息 | 所有人 | 游戏事件自动生成（穿插在公开频道中）|

**布局：**
```
┌──────────────────────┐
│ ● 已连接  第1天·白天  AXKM│
├──────────────────────┤
│ [公开] [悄悄话▼] [邪恶] [🤖AI]│ ← 频道切换标签
├──────────────────────┤
│                      │
│  🔔 系统: 白天开始    │
│                      │
│  3号: 我是洗衣妇，    │
│  我看到了...          │
│                      │
│  5号: 有人是厨师吗？  │
│                      │
│  🔔 系统: 7号         │
│  被提名了             │
│                      │
│  ...                 │
│                      │
├──────────────────────┤
│ [输入消息...]    [发送]│
├──────────────────────┤
│  广场  聊天  事件  我的 │
└──────────────────────┘
```

**悄悄话交互：**
- 点击「悄悄话」标签 → 下拉菜单显示座位号列表（如「与3号悄悄话」「与5号悄悄话」）
- 选择座位号后进入私聊视图
- 其他玩家在镇广场上能看到两人之间的悄悄话指示线（半透明连线 + 信封动画）
- 悄悄话持续时间可见但内容不可见（模拟现实中的悄悄话长度暗示）

**系统消息样式：**
- 灰色背景条，居中文本
- 带有图标前缀（🌙夜晚、☀️白天、⚰️死亡、🗳投票等）
- 不可回复

**交互：**
- 消息列表自动滚动到底部
- 长按消息可复制文本
- 夜晚阶段公开聊天被锁定（显示「夜晚期间聊天已暂停」）
- 邪恶频道仅在你是邪恶阵营时显示
- AI 助手频道**任何阶段均可用**（包括夜晚）

### 4.4.1 AI 助手频道（AI Assistant）

**核心功能：** 玩家可以随时向 AI 助手提问，获取关于角色、策略、规则的帮助。

**布局：**
```
┌──────────────────────┐
│ [公开] [悄悄话▼] [邪恶] [🤖AI] │
├──────────────────────┤
│                      │
│  🤖 你好！我是你的游戏│
│  助手。你可以问我：   │
│  · 你的角色怎么玩     │
│  · 游戏规则           │
│  · 策略建议           │
│  · 其他角色的能力     │
│                      │
│  你: 我是洗衣妇，首夜 │
│  得到的信息该怎么用？  │
│                      │
│  🤖 洗衣妇的首夜信息  │
│  非常重要！说书人会告  │
│  诉你两位玩家中有一位  │
│  是某个特定角色。你应  │
│  该：                 │
│  1. 记住这个信息      │
│  2. 在白天讨论时选择   │
│     合适时机分享...    │
│                      │
├──────────────────────┤
│ [问AI助手...]    [发送]│
└──────────────────────┘
```

**特性：**
- **上下文感知**：AI 助手知道你当前的角色（通过后端传递），给出针对性建议
- **不泄露信息**：AI 助手不会告诉你其他玩家的真实角色或任何你不应该知道的信息
- **快捷提问**：首次进入时显示常见问题快捷按钮：
  - 「我的角色怎么玩？」
  - 「当前局势分析」
  - 「投票策略建议」
  - 「这个角色是什么？」（可输入角色名）
- **完全私密**：对话内容仅存储在本地，其他玩家不可见
- **非游戏阻塞**：AI 回复不影响游戏流程，不会延迟阶段推进
- **多语言**：根据用户当前语言设置回复
- 通过后端 `/v1/rooms/{id}/assistant` API 发送问题（或 WebSocket `assistant.ask` 指令）

**AI 助手的回答范围：**
| 可以回答 | 不可以回答 |
|---------|-----------|
| 你的角色的能力和策略 | 其他玩家的真实角色 |
| 游戏通用规则 | AI 说书人的内部决策逻辑 |
| 剧本中所有角色的公开信息 | 谁是邪恶阵营 |
| 投票/提名的一般策略 | 夜晚行动的具体计算过程 |
| 历史上的公开事件（谁被处决等）| 中毒/醉酒等隐藏状态 |

### 4.5 游戏主界面 — 时间线（Timeline Tab）

**功能：** 记录所有游戏事件的有序列表，作为游戏日志。

**布局：**
```
┌──────────────────────┐
│ ● 已连接  第2天·白天  AXKM│
├──────────────────────┤
│ 筛选: [全部] 阶段 死亡 投票│
├──────────────────────┤
│                      │
│  ── 第 2 天 ──       │
│  ☀️ 06:32 白天开始    │
│  💬 06:33 公开讨论中   │
│                      │
│  ── 第 1 夜 ──       │
│  🌙 06:28 夜晚开始    │
│  🔮 06:29 你使用了能力 │
│  → 选择了: 3号        │
│  → 结果: 是外来者     │
│  ☠️ 06:31 5号 在夜晚死亡│
│                      │
│  ── 第 1 天 ──       │
│  ☀️ 06:20 游戏开始    │
│  📋 06:22 3号 提名 7号 │
│  🗳 06:23 投票: 5赞成/3反对│
│  → 7号 被处决         │
│                      │
├──────────────────────┤
│  广场  聊天  事件  我的 │
└──────────────────────┘
```

**事件类型：**

| 类型 | 图标 | 包含信息 |
|------|------|---------|
| 阶段变更 | ☀️🌙 | 阶段名称、时间 |
| 死亡 | ☠️ | 死者座位号、死因（处决/夜杀）|
| 提名 | 📋 | 提名者座位号、被提名者座位号 |
| 投票结果 | 🗳 | 赞成/反对数、结果 |
| 能力使用 | 🔮 | 仅自己可见的能力记录 |
| 系统 | ⚙️ | 玩家加入/离开、游戏配置变更 |

**交互：**
- 筛选标签可多选
- 点击事件条目可展开详情
- 自己的能力使用记录仅自己可见（隐私保护）
- 支持滚动到任意历史位置

### 4.6 游戏主界面 — 我的（Me Tab）

**功能：** 个人角色信息中心 + 设置。

**布局：**
```
┌──────────────────────┐
│ ● 已连接  第1天·白天  AXKM│
├──────────────────────┤
│                      │
│     ┌────────────┐   │
│     │ [角色图标]  │   │
│     │            │   │
│     │  洗衣妇     │   │ ← 角色卡片，阵营色边框
│     │  Washerwoman│   │
│     │  镇民       │   │
│     │            │   │
│     │ 你的首夜行动:│   │
│     │ 你得知两位玩 │   │
│     │ 家中有一位是 │   │
│     │ 某个特定角色 │   │
│     └────────────┘   │
│                      │
│  [🤖 问AI怎么玩这个角色]│ ← 跳转到AI助手频道
│                      │
│  ── 我的标记 ──      │
│  3号: 标记为厨师      │ ← 汇总圆环上的标记
│  5号: 标记为间谍      │
│  7号: 标记为善良      │
│                      │
│  ── 我的笔记 ──      │
│  ┌────────────────┐  │
│  │ [自由文本输入]  │  │ ← 玩家可记笔记
│  └────────────────┘  │
│                      │
│  ── 游戏参考 ──      │
│  [角色能力速查]       │ ← 展开当前剧本所有角色
│  [夜晚行动顺序]       │
│  [阵营配比]           │
│                      │
│  ── 设置 ──          │
│  音效: [开/关]        │
│  动画: [开/关]        │
│  语言: [中文/EN]      │
│                      │
├──────────────────────┤
│  广场  聊天  事件  我的 │
└──────────────────────┘
```

**交互：**
- 角色卡片在游戏开始前显示「等待 AI 分配角色...」
- 角色卡片可点击展开全屏详情（包含完整能力描述、提醒词、首夜/后续夜行动说明）
- 角色卡片下方有「问 AI 助手怎么玩这个角色」快捷按钮，点击跳转到聊天的 AI 助手频道
- 笔记区域支持自由文本，数据存储在 localStorage
- 参考信息按需加载，不占用初始视口
- 如果玩家是恶魔，额外显示「诈死身份」区域（3 个假角色）
- 如果玩家已死亡，显示「你已死亡」状态 + 幽灵投票剩余次数
- 「我的标记」区域：汇总显示你在圆环上标记的所有角色猜测列表

### 4.7 夜晚行动面板（Night Action Panel）— 全屏覆盖层

当夜晚阶段轮到玩家行动时，弹出全屏覆盖层。

**流程（分步向导式）：**

```
步骤 1：唤醒提示
┌──────────────────────┐
│                      │
│   ✧ 夜幕降临 ✧       │
│                      │
│   你被唤醒了          │
│                      │
│   ┌──────────────┐   │
│   │  [角色图标]   │   │
│   │  洗衣妇       │   │
│   └──────────────┘   │
│                      │
│   你的能力:           │
│   "你得知两位玩家中   │
│    有一位是某个特定角色"│
│                      │
│   ┌────────────────┐ │
│   │    我知道了     │ │
│   └────────────────┘ │
└──────────────────────┘

步骤 2：选择目标（如需要）
┌──────────────────────┐
│                      │
│   选择一位玩家:       │
│                      │
│   ┌──┐ ┌──┐ ┌──┐    │
│   │2号│ │3号│ │4号│   │  ← 可选目标（座位号）
│   └──┘ └──┘ └──┘    │     如有标记则显示标记图标
│   ┌──┐ ┌──┐ ┌──┐    │
│   │5号│ │6号│ │7号│   │
│   └──┘ └──┘ └──┘    │
│                      │
│   已选择: 3号 ✓       │
│                      │
│   ┌────────────────┐ │
│   │    确认选择     │ │
│   └────────────────┘ │
└──────────────────────┘

步骤 3：等待结果
┌──────────────────────┐
│                      │
│   ⏳ AI说书人处理中...  │  ← 加载动画
│                      │
└──────────────────────┘

步骤 4：查看结果
┌──────────────────────┐
│                      │
│   ✧ 信息 ✧           │
│                      │
│   AI说书人告诉你:     │
│                      │
│   "3号 和 5号 中      │
│    有一位是 厨师"      │
│                      │
│   ┌────────────────┐ │
│   │   知道了，入睡   │ │
│   └────────────────┘ │
└──────────────────────┘
```

**设计要点：**
- 深蓝色渐变背景 + 星空粒子动画，营造夜晚氛围
- 每一步之间有平滑过渡动画（淡入淡出）
- 目标选择使用大号头像卡片（最少 64x64px 触控区域）
- 被动能力角色（如厨师）跳过步骤 2，直接显示结果
- 信息类能力结果持久化到时间线
- 面板关闭后返回夜晚等待画面

**夜晚等待画面（非行动期间）：**
```
┌──────────────────────┐
│                      │
│   🌙 夜晚            │
│                      │
│   请闭上眼睛等待...   │
│                      │
│   [月亮呼吸动画]      │ ← 缓慢的月亮明暗变化
│                      │
│   当前进度: 3/8       │ ← 后端自动推送进度
│                      │
└──────────────────────┘
```

### 4.8 提名与投票（Nomination & Voting）— 覆盖层 + 广场联动

**提名阶段：**

白天讨论阶段，任何存活的玩家可以提名另一位玩家（每人每天限一次提名机会）。玩家在圆环上点击他人节点，选择「提名此玩家」发起提名。AI 说书人自动管理提名队列和流程。

提名发起后，所有玩家的镇广场视图自动更新：

```
┌──────────────────────┐
│ ● 已连接 第1天·提名中 AXKM│
├──────────────────────┤
│                      │
│   3号 提名了 7号      │ ← 顶部横幅
│                      │
│       [8] [1]        │
│    [7]   ↗   [2]    │ ← 提名者→被提名者
│          ↙           │    有箭头动画连线
│   [6]         [3]    │
│                      │
│    [5]       [4]     │
│                      │
│  提名者: 3号          │
│  被提名者: 7号        │
│  需要票数: 4 (8人存活)│
│                      │
├──────────────────────┤
│  广场  聊天  事件  我的 │
└──────────────────────┘
```

**投票阶段：**

从被提名者的顺时针下一位开始，依次投票：

```
┌──────────────────────┐
│ ● 已连接 第1天·投票中 AXKM│
├──────────────────────┤
│                      │
│   对 7号 的投票       │
│   当前: 3 票 / 需要 4 │
│   ━━━━━━━━░░░░░░     │ ← 投票进度条
│                      │
│      [8]  [1]        │
│   [7]        [✋2]   │ ← 当前投票者高亮
│                      │
│  [6]          [3]    │
│                      │
│   [5]        [4]     │
│                      │
│  ── 轮到你投票了！── │ ← 当轮到自己时显示
│                      │
│  ┌───────┐ ┌───────┐ │
│  │  👍   │ │  👎   │ │ ← 大号投票按钮
│  │ 赞成  │ │ 反对  │ │
│  └───────┘ └───────┘ │
│                      │
├──────────────────────┤
│  广场  聊天  事件  我的 │
└──────────────────────┘
```

**投票结果：**
```
┌──────────────────────┐
│                      │
│   投票结果            │
│                      │
│   7号                 │
│   5 票赞成 / 3 票反对 │
│                      │
│   ✅ 达到多数，被处决  │
│   或                  │
│   ❌ 未达多数，安全    │
│                      │
│      [3秒后自动关闭]  │
└──────────────────────┘
```

**设计要点：**
- 投票按钮在轮到自己时才出现，避免提前投票
- 投票进度条实时更新
- 已投票的玩家在圆环上显示其投票结果（赞成=蓝色勾、反对=灰色叉）
- 倒计时投票模式（AI 说书人自动管理）：每位玩家有固定秒数做决定
- 死亡玩家如有幽灵投票，按钮旁显示「幽灵投票（仅剩 1 次）」
- 投票结果卡片自动归档到时间线

### 4.9 阶段切换动画（Phase Transitions）

每次阶段变更触发全屏过渡动画：

| 过渡 | 动画描述 | 持续时间 |
|------|---------|---------|
| 白天 → 夜晚 | 从圆环中心扩散的深蓝色圆形遮罩，星星逐渐出现，配合暗沉音效 | 1.5s 动画 + 1s 文字 |
| 夜晚 → 白天 | 从左侧（东方）横扫的暖橙色渐变，模拟日出，配合鸡鸣/钟声音效 | 1.5s 动画 + 1s 文字 |
| 白天 → 提名 | 快速红色脉冲边框，无全屏遮罩，仅顶部横幅滑入 | 0.5s |
| 投票结束 → 白天 | 结果卡片淡出，广场恢复正常 | 0.5s |
| 游戏结束（善良胜）| 金色光芒从中心爆发 + 胜利文字 | 3s |
| 游戏结束（邪恶胜）| 红色裂纹从边缘蔓延 + 失败文字 | 3s |

- 所有动画支持「点击跳过」
- 尊重 `prefers-reduced-motion`，关闭动画时仅显示文字提示
- 音效尊重静音设置

### 4.10 游戏结束画面（Game End Screen）

```
┌──────────────────────┐
│                      │
│                      │
│    ✧ 游戏结束 ✧      │
│                      │
│    善良方获胜！        │
│    或: 邪恶方获胜！    │
│                      │
│    获胜原因:          │
│    "恶魔被处决了"     │
│                      │
│    ── 角色揭示 ──    │
│    1号: 洗衣妇 (镇民)  │
│    2号: 间谍 (爪牙)    │
│    3号: 小恶魔 (恶魔) ← 你│
│    ...               │
│                      │
│    ── 游戏统计 ──    │
│    持续时间: 45 分钟  │
│    总天数: 3         │
│    总死亡: 5         │
│    总投票: 8 次      │
│                      │
│  ┌────────────────┐  │
│  │  返回大厅       │  │
│  └────────────────┘  │
│  ┌────────────────┐  │
│  │  返回首页       │  │
│  └────────────────┘  │
└──────────────────────┘
```

---

## 五、玩家提名系统

由于 AI 说书人全自动运行，提名是玩家在白天唯一的主动操作（除聊天外）。

### 5.1 提名规则

- 每位**存活**玩家每天最多发起**一次**提名
- 每位玩家每天最多被提名**一次**
- 死亡玩家不可提名他人，也不可被提名
- 已用完提名机会的玩家，圆环上的「提名此玩家」按钮灰显
- AI 说书人会在白天阶段结束前给出提名窗口时间（系统消息提示："提名窗口即将关闭"）

### 5.2 提名交互流程

1. 白天阶段，玩家点击他人节点 → 操作面板显示「提名此玩家」
2. 点击「提名此玩家」→ 二次确认弹窗：「确定要提名 X号 吗？」
3. 确认后发送 `nominate` 指令 → 后端 AI 说书人自动开始投票流程
4. 所有玩家收到 `nomination.started` 事件，进入投票阶段

### 5.3 提名状态在广场上的展示

- 已用完提名的玩家：节点右下角灰色圆点标记
- 已被提名过的玩家：节点右下角红色圆点标记
- 提名窗口关闭后：所有节点的提名按钮消失

---

## 六、响应式布局策略

### 6.1 断点定义

| 断点 | 宽度范围 | 布局策略 |
|------|---------|---------|
| 手机竖屏 | < 576px | 底部导航，单列布局，全屏覆盖层 |
| 手机横屏 | 576-767px | 底部导航，双列可选 |
| 平板 | 768-1199px | 侧边栏 + 主内容区 |
| 桌面 | ≥ 1200px | 三栏布局（侧栏 + 广场 + 聊天/时间线）|

### 6.2 桌面端布局

```
┌────────────────────────────────────────────┐
│ ● 已连接      第 1 天 · 白天讨论      AXKM  │
├────────┬───────────────────┬───────────────┤
│        │                   │               │
│ 座位列表│    镇广场圆环      │   聊天/时间线  │
│ +标记   │                   │   [标签切换]   │
│ 1号 ●  │                   │               │
│ 2号 ●  │    [圆环区域]      │   消息列表     │
│ 3号 ☠  │                   │               │
│ 4号 ●  │                   │               │
│ ...    │                   │   输入框       │
│        │                   │               │
│ 我的角色│   存活:5 死亡:3    │               │
│        │                   │               │
├────────┴───────────────────┴───────────────┤
│                                            │
│  角色卡片浮动按钮 / AI 助手入口               │
└────────────────────────────────────────────┘
```

### 6.3 平板端布局

```
┌──────────────────────────────┐
│ ● 已连接  第1天·白天   AXKM  │
├──────────────┬───────────────┤
│              │               │
│  镇广场圆环   │  聊天/时间线   │
│              │  [标签切换]    │
│              │               │
│              │               │
├──────────────┴───────────────┤
│  底部导航栏                    │
└──────────────────────────────┘
```

---

## 七、视觉设计规范

### 7.1 配色方案

**基础色板（暗色主题）：**

| 用途 | 颜色 | 值 |
|------|------|---|
| 背景（最深层）| 深黑 | `#0D0D0D` |
| 背景（卡片层）| 深灰 | `#1A1A1A` |
| 背景（浮层）| 中灰 | `#242424` |
| 背景（高亮）| 亮灰 | `#333333` |
| 文字（主要）| 浅白 | `rgba(255,255,255,0.87)` |
| 文字（次要）| 灰白 | `rgba(255,255,255,0.60)` |
| 文字（禁用）| 暗灰 | `rgba(255,255,255,0.38)` |
| 分割线 | 微灰 | `rgba(255,255,255,0.12)` |

**阵营色板：**

| 阵营 | 颜色 | 值 | 用途 |
|------|------|---|------|
| 镇民 | 蓝色 | `#4A90D9` | 边框、标签、按钮 |
| 外来者 | 青色 | `#5BC0DE` | 边框、标签 |
| 爪牙 | 橙色 | `#E67E22` | 边框、标签 |
| 恶魔 | 红色 | `#C0392B` | 边框、标签、投票按钮 |
| 旅行者 | 紫色 | `#9B59B6` | 边框、标签 |
| 传说 | 金色 | `#F1C40F` | 边框、标签 |

**功能色：**

| 用途 | 颜色 | 值 |
|------|------|---|
| 成功/安全 | 绿色 | `#27AE60` |
| 警告 | 琥珀色 | `#F39C12` |
| 危险/错误 | 红色 | `#E74C3C` |
| 信息 | 蓝色 | `#3498DB` |
| 连接正常 | 绿色 | `#2ECC71` |
| 重连中 | 黄色 | `#F1C40F` |
| 断开 | 红色 | `#E74C3C` |

### 7.2 字体体系

| 用途 | 字体 | 大小 | 粗细 |
|------|------|------|------|
| 品牌标题 | PiratesBay | 32-48px | Normal |
| 游戏标题（阶段名等）| Papyrus | 24-32px | Bold |
| UI 标题 | System sans-serif | 18-20px | 600 |
| 正文 | System sans-serif | 14-16px | 400 |
| 辅助文字 | System sans-serif | 12px | 400 |
| 房间号/代码 | Monospace | 24-32px | 700 |

> 使用系统字体栈减少加载时间：`-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`
> PiratesBay 和 Papyrus 仅用于装饰性标题，非核心 UI

### 7.3 间距与尺寸

| 元素 | 尺寸 |
|------|------|
| 基础间距单位 | 4px |
| 内边距（卡片）| 16px |
| 内边距（按钮）| 12px 24px |
| 外间距（区块间）| 16-24px |
| 圆角（按钮）| 8px |
| 圆角（卡片）| 12px |
| 圆角（头像）| 50% (圆形) |
| 触控最小面积 | 48x48px |
| 玩家节点大小 | 56-72px（根据玩家数动态缩放）|

### 7.4 动画规范

| 场景 | 属性 | 时长 | 缓动 |
|------|------|------|------|
| 按钮点击反馈 | transform: scale | 100ms | ease-out |
| 面板滑入 | transform: translateY | 300ms | ease-out |
| 面板滑出 | transform: translateY | 250ms | ease-in |
| 淡入 | opacity | 200ms | ease-out |
| 淡出 | opacity | 150ms | ease-in |
| 阶段全屏过渡 | 自定义 | 1500ms | custom |
| 加载旋转 | transform: rotate | 1000ms | linear |
| 脉冲提醒 | transform: scale + opacity | 2000ms | ease-in-out |

- 仅动画 `transform` 和 `opacity`（GPU 加速）
- 所有动画声明 `will-change` 提示
- 支持 `prefers-reduced-motion` 全局降级

---

## 八、状态管理架构（Vuex 重新设计）

### 8.1 Store 模块划分

```
store/
├── index.js              ← 根 Store + 全局状态
├── modules/
│   ├── game.js           ← 游戏核心状态（阶段、天数、胜负）
│   ├── players.js        ← 玩家列表与状态
│   ├── annotations.js    ← 玩家角色标记/猜测（本地持久化）
│   ├── chat.js           ← 聊天消息管理（含 AI 助手频道）
│   ├── timeline.js       ← 事件时间线
│   ├── night.js          ← 夜晚行动状态
│   ├── vote.js           ← 提名与投票状态
│   └── ui.js             ← UI 状态（导航、弹窗、设置）
├── plugins/
│   ├── websocket.js      ← WebSocket 连接管理
│   └── persistence.js    ← localStorage 持久化
└── helpers.js            ← 公共工具函数
```

### 8.2 各模块状态定义

**根状态 (index.js)：**
```javascript
{
  roomId: '',           // 当前房间号
  role: 'spectator',    // 'player' | 'spectator'（无 storyteller，AI 自动化）
  isRoomOwner: false,   // 是否是房主（仅大厅阶段有意义）
  playerId: '',         // 自己的玩家 ID
  seatIndex: -1,        // 座位索引（-1 = 未入座）
  edition: null,        // 当前剧本数据
  roles: {},            // 剧本中所有角色映射
  connected: false,     // WebSocket 连接状态
  reconnecting: false,  // 是否正在重连
  latencyMs: 0          // 延迟
}
```

**game 模块：**
```javascript
{
  phase: 'lobby',       // 'lobby' | 'first_night' | 'night' | 'day' | 'nomination' | 'voting' | 'ended'
  dayCount: 0,
  winner: '',           // 'good' | 'evil' | ''
  winReason: '',
  alivePlayers: 0,
  deadPlayers: 0
}
```

**players 模块：**
```javascript
{
  players: [
    {
      id: '',              // 连接标识（session token）
      seatIndex: 1,        // 座位号（从 1 开始，即玩家的唯一身份）
      isAlive: true,
      hasGhostVote: true,
      isNominatedToday: false,   // 今天是否已被提名
      hasNominatedToday: false,  // 今天是否已发起提名
      isMe: false          // 是否是自己
    }
  ],
  myRole: null,                  // 仅自己的角色信息 {roleId, roleName, team, ability}
  bluffs: [null, null, null],    // 恶魔诈死身份（仅恶魔玩家收到）
  fabled: []                     // 传说角色（公开信息）
}
```
> **注意：** `myRole` 仅通过 `role.assigned` 事件设置，后端不会推送其他玩家的角色信息。
> 其他玩家的角色猜测存储在 `annotations` 模块中。

**annotations 模块（纯本地，不与后端同步）：**
```javascript
{
  // key = seatIndex（座位号），value = 你的个人标记
  playerAnnotations: {
    3: {
      guessedRoleId: 'washerwoman',  // 猜测的角色 ID（可选）
      guessedTeam: 'townsfolk',      // 猜测的阵营（可选）
      note: '声称是洗衣妇，看到了5号', // 文字备注
      updatedAt: 1708400000000
    },
    5: {
      guessedRoleId: 'spy',
      guessedTeam: 'minion',
      note: '发言可疑，和7号互相掩护',
      updatedAt: 1708400100000
    }
  }
}
```
> 持久化到 localStorage，按 roomId 隔离，仅自己可见。

**chat 模块：**
```javascript
{
  channels: {
    public: { messages: [], unread: 0 },
    evil: { messages: [], unread: 0 },
    assistant: { messages: [], unread: 0 },  // AI 助手频道（纯本地 + API）
    whispers: {
      // playerId -> { messages: [], unread: 0 }
    }
  },
  activeChannel: 'public',
  activeWhisperTarget: null,
  assistantLoading: false     // AI 助手是否正在回复
}
```

**timeline 模块：**
```javascript
{
  events: [
    {
      id: '',
      type: 'phase_change' | 'death' | 'nomination' | 'vote_result' | 'ability' | 'system',
      timestamp: 0,
      dayCount: 0,
      data: {},        // 类型特定数据
      isPrivate: false // 是否仅自己可见
    }
  ],
  filters: ['all']    // 当前筛选器
}
```

**night 模块：**
```javascript
{
  isMyTurn: false,
  step: 'idle',        // 'idle' | 'woken' | 'selecting' | 'waiting' | 'result' | 'done'
  roleId: '',
  roleName: '',
  abilityText: '',
  actionType: '',      // 'select_one' | 'select_two' | 'passive' | 'info'
  targets: [],         // 可选目标
  selectedTargets: [],
  result: '',
  progress: {          // AI 说书人推送的夜晚进度
    current: 0,
    total: 0
  }
}
```

**vote 模块：**
```javascript
{
  isActive: false,
  nominator: null,     // 玩家对象
  nominee: null,       // 玩家对象
  votes: [],           // [{playerId, vote: true/false}]
  currentVoterIndex: -1,
  requiredMajority: 0,
  currentYesCount: 0,
  myVote: null,        // true/false/null
  isMyTurn: false,
  countdown: 0,        // 倒计时秒数（0=不限时）
  result: null,        // 'executed' | 'safe' | null
  history: []          // 历史投票记录
}
```

**ui 模块：**
```javascript
{
  activeTab: 'square', // 'square' | 'chat' | 'timeline' | 'me'
  isMobile: false,
  modals: {
    roleDetail: { open: false, roleId: '' },
    playerAction: { open: false, playerId: '' },  // 点击他人节点的操作面板
    reference: false,
    nightOrder: false,
    settings: false,
    confirm: { open: false, message: '', onConfirm: null }
  },
  settings: {
    soundEnabled: true,
    animationsEnabled: true,
    locale: 'zh',
    reducedMotion: false
  },
  notes: ''            // 玩家通用笔记
}
```

---

## 九、后端 API 对接（不变，仅作参考）

### 9.1 REST API

| 方法 | 路径 | 用途 |
|------|------|------|
| POST | `/v1/rooms` | 创建房间（创建者成为房主）|
| POST | `/v1/rooms/{id}/join` | 加入房间 |
| GET | `/v1/rooms/{id}` | 获取房间状态 |
| GET | `/v1/rooms/{id}/events?after_seq={seq}` | 事件流 |
| POST | `/v1/rooms/{id}/commands` | 发送玩家指令 |
| POST | `/v1/rooms/{id}/assistant` | **AI 助手问答**（新增）|

### 9.2 WebSocket 事件

**接收事件（AI 说书人/服务端 → 客户端）：**

| 事件类型 | 数据 | 触发时机 |
|---------|------|---------|
| `player.joined` | `{id}` | 新连接加入房间（旁观者状态）|
| `player.left` | `{id}` | 玩家离开 |
| `player.seated` | `{id, seatIndex}` | 玩家入座（seatIndex 即为身份）|
| `player.unseated` | `{id, seatIndex}` | 玩家离座 |
| `role.assigned` | `{roleId, roleName, team, ability}` | AI 自动分配角色（仅发给本人）|
| `game.started` | `{edition, playerCount}` | AI 开始游戏 |
| `phase.changed` | `{phase, dayCount}` | AI 自动推进阶段 |
| `nomination.started` | `{nominatorSeat, nomineeSeat}` | 玩家发起提名后广播 |
| `nomination.window` | `{open: bool, remainingSec}` | 提名窗口开启/关闭 |
| `vote.cast` | `{seatIndex, vote}` | 投票 |
| `vote.result` | `{nomineeSeat, yesCount, noCount, result}` | 投票结果 |
| `player.died` | `{seatIndex, cause}` | AI 宣布死亡 |
| `public.chat` | `{seatIndex, message}` | 公开聊天（seatIndex=发送者座位号）|
| `whisper.received` | `{seatIndex, message}` | 悄悄话（seatIndex=对方座位号）|
| `evil_team.chat` | `{seatIndex, message}` | 邪恶频道 |
| `night.your_turn` | `{roleId, actionType, targets}` | AI 唤醒你执行夜晚行动 |
| `night.turn_end` | `{}` | 你的夜晚行动结束 |
| `ability.result` | `{result}` | AI 发送能力结果 |
| `night.progress` | `{current, total}` | 夜晚进度（匿名，不含玩家名）|
| `game.ended` | `{winner, reason, roles}` | AI 判定游戏结束 |
| `system.message` | `{message}` | AI 说书人的系统广播 |
| `assistant.reply` | `{message}` | AI 助手回复（仅发给提问者）|

**发送指令（客户端 → 服务端）：**

| 指令类型 | 数据 | 触发时机 |
|---------|------|---------|
| `claim_seat` | `{seatIndex}` | 选座 |
| `leave_seat` | `{}` | 离座 |
| `start_game` | `{edition}` | 房主开始游戏 |
| `nominate` | `{nomineeSeat}` | 玩家提名某座位号（提名者身份由后端从 session 获取）|
| `cast_vote` | `{vote: true/false}` | 投票 |
| `night_action` | `{targets: [...]}` | 夜晚选择目标 |
| `send_chat` | `{channel, message, targetSeat?}` | 发送聊天（targetSeat 用于悄悄话）|
| `assistant_ask` | `{message}` | 向 AI 助手提问 |

> **已移除的 ST 指令：** `advance_phase`、`mark_dead`、`assign_role`、`send_ability_result` 均由 AI 说书人自动执行，前端无需发送。

---

## 十、新组件清单

### 10.1 组件树

```
App.vue                          ← 根组件，屏幕切换
├── TopBar.vue                   ← 全局顶部状态栏
├── SplashScreen.vue             ← 启动画面
├── HomeScreen.vue               ← 首页（创建/加入）
│   └── JoinRoomSheet.vue        ← 房间号输入面板
├── LobbyScreen.vue              ← 大厅
│   ├── LobbyPlayerGrid.vue      ← 座位网格
│   ├── LobbyPlayerSlot.vue      ← 单个座位
│   └── EditionPicker.vue        ← 剧本选择器（房主可操作）
├── GameScreen.vue               ← 游戏主界面容器
│   ├── BottomNav.vue            ← 底部导航栏（手机）
│   ├── SquareView.vue           ← 镇广场标签
│   │   ├── PlayerCircle.vue     ← 玩家圆环
│   │   ├── PlayerNode.vue       ← 单个玩家节点（含标记显示）
│   │   ├── PlayerActionSheet.vue ← 点击他人节点的操作面板
│   │   │   ├── RoleAnnotator.vue ← 角色标记选择器
│   │   │   └── NominateButton.vue ← 提名按钮（白天阶段）
│   │   └── AliveCounter.vue     ← 存活计数条
│   ├── ChatView.vue             ← 聊天标签
│   │   ├── ChannelTabs.vue      ← 频道切换（含 AI 助手标签）
│   │   ├── MessageList.vue      ← 消息列表
│   │   ├── MessageBubble.vue    ← 单条消息
│   │   ├── ChatInput.vue        ← 输入框
│   │   └── AssistantQuickActions.vue ← AI 助手快捷提问按钮
│   ├── TimelineView.vue         ← 时间线标签
│   │   ├── TimelineFilters.vue  ← 筛选器
│   │   └── TimelineItem.vue     ← 单条事件
│   ├── MeView.vue               ← 我的标签
│   │   ├── RoleCardFull.vue     ← 完整角色卡片
│   │   ├── PlayerNotes.vue      ← 笔记区域
│   │   └── GameReference.vue    ← 参考信息
│   │       ├── RoleList.vue     ← 角色列表
│   │       └── NightOrderList.vue ← 夜晚顺序
│   ├── NightOverlay.vue         ← 夜晚覆盖层
│   │   ├── NightWakeUp.vue      ← 唤醒提示
│   │   ├── NightTargetPicker.vue ← 目标选择
│   │   ├── NightResult.vue      ← 结果展示
│   │   └── NightWaiting.vue     ← 等待画面
│   ├── VoteOverlay.vue          ← 投票覆盖层
│   │   ├── NominationBanner.vue ← 提名横幅
│   │   ├── VoteProgress.vue     ← 投票进度
│   │   └── VoteButtons.vue      ← 投票按钮
│   ├── PhaseTransition.vue      ← 阶段切换动画
│   └── GameEndScreen.vue        ← 游戏结束画面
├── SettingsPanel.vue            ← 设置面板
├── ConfirmDialog.vue            ← 通用确认弹窗
└── ToastStack.vue               ← Toast 通知容器
    └── ToastItem.vue            ← 单条 Toast
```

**总计：约 37 个组件**（移除了 3 个 ST 专属组件，新增了 4 个标记/助手组件）

### 10.2 服务层

```
services/
├── WebSocketService.js   ← WebSocket 连接、重连、消息分发
├── ApiService.js         ← REST API 封装（含 AI 助手 API）
├── SoundService.js       ← 音效管理
└── StorageService.js     ← localStorage 工具（含角色标记持久化）
```

---

## 十一、可复用资产清单（从现有项目保留）

| 资产类型 | 路径 | 用途 |
|---------|------|------|
| 角色图标 | `assets/icons/*.png` | 玩家节点、角色卡片 |
| 剧本图片 | `assets/editions/*.png` | 剧本选择器 |
| 背景图 | `assets/background.jpg` | 游戏背景 |
| 云朵图 | `assets/clouds.png` | 夜晚动画 |
| 死亡/生命标记 | `assets/death.png`, `life.png` | 玩家状态 |
| 裹尸布 | `assets/shroud.png` | 死亡动画 |
| 钟面 | `assets/clock-big.png` | 投票指针 |
| 恶魔头 | `assets/demon-head*.png` | 装饰 |
| 叶子装饰 | `assets/leaf-*.png` | UI 装饰 |
| 代币 | `assets/token.png` | 玩家底座 |
| 字体 | `assets/fonts/*` | PiratesBay, Papyrus |
| 音效 | `assets/sounds/countdown.mp3` | 投票倒计时 |
| PWA 图标 | `public/static/*` | PWA 支持 |
| 游戏数据 | `src/*.json` | 角色、剧本、阵营配比 |
| i18n | `src/i18n/*.json` | 国际化文本（需扩展） |

---

## 十二、i18n 字符串结构（重新设计）

```json
{
  "app": {
    "title": "Blood on the Clocktower",
    "subtitle": "Auto Storyteller"
  },
  "home": {
    "createRoom": "创建房间",
    "joinRoom": "加入房间",
    "soloMode": "单人模式",
    "enterRoomCode": "输入房间号",
    "settings": "设置"
  },
  "lobby": {
    "roomCode": "房间号",
    "copyLink": "复制邀请链接",
    "seatedPlayers": "已入座 ({count}/{total})",
    "spectators": "旁观者 ({count})",
    "waitingForStart": "等待房主开始游戏...",
    "startGame": "开始游戏",
    "leaveRoom": "离开房间",
    "edition": "剧本",
    "expectedTeams": "预计阵营",
    "seatCount": "座位数"
  },
  "game": {
    "phases": {
      "first_night": "首夜",
      "night": "夜晚",
      "day": "白天",
      "nomination": "提名中",
      "voting": "投票中",
      "ended": "游戏结束"
    },
    "dayCount": "第 {n} 天",
    "alive": "存活",
    "dead": "死亡"
  },
  "square": {
    "title": "广场",
    "townSquare": "镇广场",
    "annotate": "标记角色",
    "annotateTeam": "标记阵营",
    "addNote": "添加笔记",
    "clearAnnotation": "清除标记",
    "nominatePlayer": "提名此玩家",
    "nominationUsed": "今日已提名",
    "alreadyNominated": "今日已被提名",
    "whisperTo": "悄悄话"
  },
  "chat": {
    "title": "聊天",
    "public": "公开",
    "whisper": "悄悄话",
    "evil": "邪恶频道",
    "assistant": "AI 助手",
    "placeholder": "输入消息...",
    "assistantPlaceholder": "问 AI 助手...",
    "send": "发送",
    "nightLocked": "夜晚期间聊天已暂停",
    "assistantWelcome": "你好！我是你的游戏助手。你可以问我角色策略、游戏规则等问题。",
    "assistantThinking": "思考中...",
    "quickAsk": {
      "howToPlay": "我的角色怎么玩？",
      "situation": "当前局势分析",
      "voteStrategy": "投票策略建议",
      "whatIsRole": "这个角色是什么？"
    }
  },
  "timeline": {
    "title": "事件",
    "filters": {
      "all": "全部",
      "phase": "阶段",
      "death": "死亡",
      "vote": "投票",
      "ability": "能力"
    }
  },
  "me": {
    "title": "我的",
    "waitingForRole": "等待 AI 分配角色...",
    "yourRole": "你的角色",
    "askAI": "问 AI 怎么玩这个角色",
    "annotations": "我的标记",
    "annotationMarkedAs": "标记为 {role}",
    "annotationTeam": "标记为 {team}",
    "notes": "我的笔记",
    "notesPlaceholder": "在这里记笔记...",
    "reference": "游戏参考",
    "roleList": "角色列表",
    "nightOrder": "夜晚顺序",
    "teamComposition": "阵营配比",
    "youAreDead": "你已死亡",
    "ghostVotesLeft": "幽灵投票剩余: {n}",
    "bluffs": "诈死身份"
  },
  "night": {
    "youAreWoken": "你被唤醒了",
    "yourAbility": "你的能力",
    "gotIt": "我知道了",
    "selectTarget": "选择目标",
    "selectTargets": "选择 {n} 个目标",
    "confirm": "确认选择",
    "waiting": "AI 说书人正在处理...",
    "result": "AI 说书人告诉你",
    "goToSleep": "知道了，入睡",
    "nightFalls": "夜幕降临",
    "closeYourEyes": "请闭上眼睛等待...",
    "progress": "当前进度: {current}/{total}"
  },
  "vote": {
    "nomination": "{nominator}号 提名了 {nominee}号",
    "votesNeeded": "需要 {count} 票",
    "currentVotes": "当前 {count} 票",
    "yourTurn": "轮到你投票了！",
    "voteYes": "赞成",
    "voteNo": "反对",
    "ghostVote": "幽灵投票（仅剩 1 次）",
    "result": {
      "executed": "被处决",
      "safe": "安全"
    }
  },
  "gameEnd": {
    "gameOver": "游戏结束",
    "goodWins": "善良方获胜！",
    "evilWins": "邪恶方获胜！",
    "reason": "获胜原因",
    "roleReveal": "角色揭示",
    "stats": "游戏统计",
    "duration": "持续时间",
    "totalDays": "总天数",
    "totalDeaths": "总死亡",
    "totalVotes": "总投票",
    "backToLobby": "返回大厅",
    "backToHome": "返回首页"
  },
  "nomination": {
    "confirmTitle": "确认提名",
    "confirmMessage": "确定要提名 {seat}号 吗？",
    "windowClosing": "提名窗口即将关闭",
    "windowClosed": "提名窗口已关闭",
    "youNominated": "你提名了 {seat}号",
    "limitReached": "你今天已经提名过了"
  },
  "connection": {
    "connected": "已连接",
    "reconnecting": "重连中...",
    "disconnected": "连接断开"
  },
  "settings": {
    "title": "设置",
    "sound": "音效",
    "animations": "动画",
    "language": "语言",
    "on": "开",
    "off": "关"
  },
  "common": {
    "confirm": "确认",
    "cancel": "取消",
    "close": "关闭",
    "copied": "已复制",
    "loading": "加载中..."
  }
}
```

---

## 十三、开发分期计划

### Phase 1：基础框架 + 首页 + 大厅 ✅ 已完成
- ✅ 搭建新的组件骨架（App, TopBar, BottomNav）
- ✅ 实现 Vuex Store 全新架构（game, players, annotations, chat, timeline, night, vote, ui 共 8 个模块）
- ✅ WebSocket 服务层 + API 服务 + Sound 服务 + Storage 服务
- ✅ 首页（HomeScreen）+ 房间号输入（JoinRoomSheet）
- ✅ 大厅（LobbyScreen）+ 座位系统（LobbyPlayerGrid + LobbyPlayerSlot）+ 房主配置（EditionPicker）
- ✅ i18n 重写（zh.json + en.json 全新结构）
- ✅ 全局组件：ConfirmDialog, SettingsPanel, GameEndScreen
- ✅ 构建验证通过

### Phase 2：游戏核心 — 镇广场 + 角色标记系统 ✅ 已完成
- ✅ 玩家圆环（PlayerCircle + PlayerNode）
- ✅ 玩家节点可见性规则（仅自己角色可见，他人显示 ?）
- ✅ 角色标记系统（PlayerActionSheet + RoleAnnotator，含角色选择、阵营标记、笔记）
- ✅ SquareView 容器 + AliveCounter 存活计数条
- ✅ 游戏状态管理（game 模块已在 Phase 1 完成）
- ✅ GameScreen 集成 SquareView
- ✅ 构建验证通过

### Phase 3：夜晚行动 + 提名 + 投票系统 ✅ 已完成
- ✅ 夜晚行动向导（NightOverlay：唤醒→目标选择→等待→结果 四步骤）
- ✅ 玩家主动提名流程（通过 PlayerActionSheet 中的提名按钮发起）
- ✅ 投票流程（VoteOverlay：提名横幅 + 投票进度条 + 赞成/反对按钮 + 结果显示）
- ✅ 阶段切换动画（PhaseTransition：全屏渐变动画，2秒自动消失）
- ✅ 全部集成到 App.vue，构建验证通过

### Phase 4：聊天 + AI 助手 + 时间线 + 我的 ✅
- ✅ 聊天系统（ChatView 全套，含频道切换：公共/私聊/邪恶/AI助手）
- ✅ AI 助手频道（快捷操作按钮 + apiService.askAssistant 对接 + 打字指示动画）
- ✅ 时间线（TimelineView 全套：事件列表 + 类型筛选 + 彩色圆点 + 时间戳）
- ✅ 我的页面（MeView 全套：角色卡 + 阵营色 + 能力描述 + 恶魔诈唬 + 笔记 + 设置入口）
- ✅ 玩家笔记（防抖保存到 Vuex ui/notes + localStorage 持久化）
- ✅ GameScreen 集成（四个 tab 全部替换为实际组件，v-show 切换）
- 游戏参考信息（待后续迭代）

### Phase 5：收尾 + 优化 ✅
- ✅ 响应式布局完善（media.scss 重写：桌面三栏 ≥1200px + 平板双栏 768-1199px + 手机单列）
- ✅ GameScreen 桌面模式：左侧栏 MeView + 中间 SquareView + 右侧 Chat/Timeline 标签切换
- ✅ 动画性能优化（所有动画已使用 transform/opacity，GPU 加速）
- ✅ 清理旧文件：删除 23 个废弃组件 + 6 个旧 modals + 5 个旧 store 文件 + api/backend.js
- ✅ 无障碍（a11y）：BottomNav role=tablist + PlayerNode role=button/tabindex/键盘支持 + VoteOverlay/NightOverlay aria-label
- ✅ PWA 更新（manifest.json: display=standalone, orientation=portrait-primary, background_color, purpose=maskable）
- ✅ 完善 i18n（中英文 159 个 key 完全对齐，无遗漏）
- ✅ index.html 更新（lang="en", title, description, og 标签）
- 全面测试（待后续集成测试）

---

## 十四、异常处理与边界场景

### 14.1 连接断开与重连

| 场景 | 前端行为 |
|------|---------|
| WebSocket 断开 | 顶部状态栏变黄闪烁「重连中...」，自动尝试重连（指数退避：1s, 2s, 4s, 8s, 最大 30s）|
| 重连成功 | 通过 `after_seq` 参数拉取断线期间的所有事件，补充到本地状态 |
| 重连失败超过 60s | 状态栏变红「连接断开」，显示手动「重试」按钮 |
| 夜晚行动期间断线 | 重连后如果仍在自己的行动窗口则恢复面板；如果窗口已过，AI 说书人视为放弃行动 |
| 投票期间断线 | 重连后如果仍轮到自己投票则恢复投票按钮；如果已过，视为弃权 |
| 断线期间游戏结束 | 重连后直接显示游戏结束画面 |

### 14.2 超时与弃权

| 场景 | 行为 |
|------|------|
| 夜晚行动超时 | AI 说书人设定超时时间（如 60s），超时后自动跳过该玩家（前端显示「行动时间已过」提示）|
| 投票超时 | 倒计时结束后自动视为弃权（不投票），前端灰显投票按钮 |
| 提名窗口关闭 | AI 说书人自动推进到下一阶段，前端移除所有提名按钮 |

### 14.3 房间错误处理

| 场景 | 前端行为 |
|------|---------|
| 房间号不存在 | 输入面板显示红色提示「房间不存在」|
| 房间已满 | 加入后以旁观者身份进入，提示「所有座位已满，你正在旁观」|
| 房间游戏已开始 | 加入后以旁观者身份进入，提示「游戏进行中，你正在旁观」|
| 创建房间失败 | Toast 提示「创建失败，请重试」|
| 被房主踢出 | 自动跳转到首页，Toast 提示「你已被移出房间」|

### 14.4 数据一致性

- 前端以后端推送的事件为唯一真相源（single source of truth）
- 本地状态（标记、笔记、设置）与游戏状态严格分离
- 重连后通过事件回放恢复完整游戏状态
- localStorage 数据按 `roomId` 命名空间隔离，避免跨房间污染
- 旧房间的本地数据在 7 天后自动清理

---

## 十五、不在范围内（Out of Scope）

以下功能在本次重写中**不实现**：

1. 后端 API 修改 — 前端适配现有 API
2. 新角色/剧本数据 — 使用现有 JSON 数据
3. 用户注册/登录/用户名系统 — 座位号即身份，完全匿名
4. 游戏回放系统 — 时间线仅作实时日志
5. 语音聊天 — 仅文字聊天
6. 多语言扩展（除中英外）— 后续可加
7. 自定义角色编辑器 — 后续可加
8. 游戏数据统计/排行榜 — 后续可加
9. 人类说书人模式 — 本项目仅支持 AI 自动说书人

---

## 十六、验收标准

1. **功能完整性**：所有后端事件均有对应 UI 响应，所有指令均可通过 UI 发出
2. **匿名体验**：从打开页面到进入游戏，全程无需输入任何个人信息
3. **响应式**：在 iPhone SE（375px）到 27" 桌面（2560px）均可正常使用
4. **性能**：首屏加载 < 3s（4G 网络），60fps 动画，无内存泄漏
5. **国际化**：所有用户可见文本均通过 i18n，中英双语完整
6. **无障碍**：WCAG 2.1 AA 合规（对比度、键盘导航、屏幕阅读器基础支持）
7. **代码质量**：ESLint 零警告，组件单一职责，Props 类型校验
8. **断线恢复**：断线重连后游戏状态完整恢复，无信息丢失

---

*文档结束 — v3.0。请确认后开始开发。*
