# 需求文档

## 介绍

无说书人自动化模式（Player-Only Mode）是在现有自动化说书人系统基础上的重要扩展，旨在实现完全无需人类说书人的游戏体验。核心创新是角色隐私保护机制：每个玩家只能看到自己的角色卡，其他玩家的角色卡显示为背面（不可见），而系统作为"隐形说书人"掌握所有信息但不向任何玩家展示。这种设计让玩家可以在没有说书人的情况下享受完整的血染钟楼游戏体验。

## 术语表

- **无说书人模式 (Player_Only_Mode)**: 不需要人类说书人的游戏模式，系统自动管理所有游戏逻辑
- **角色隐私保护系统 (Role_Privacy_System)**: 确保每个玩家只能看到自己角色的安全机制
- **玩家身份验证器 (Player_Authenticator)**: 验证玩家身份并管理座位认领的组件
- **视角过滤器 (Perspective_Filter)**: 根据玩家身份过滤可见信息的组件
- **隐形说书人 (Invisible_Storyteller)**: 系统扮演的说书人角色，掌握所有信息但不向玩家展示
- **座位认领 (Seat_Claim)**: 玩家加入游戏时认领特定座位的过程
- **角色卡背面 (Role_Card_Back)**: 其他玩家角色卡的隐藏显示状态
- **公开信息 (Public_Information)**: 所有玩家都可以看到的游戏信息
- **私密信息 (Private_Information)**: 只有特定玩家可以看到的信息
- **游戏模式切换器 (Mode_Switcher)**: 在说书人模式和无说书人模式之间切换的组件

## 需求

### 需求 1: 角色隐私保护

**用户故事:** 作为玩家，我希望只能看到自己的角色卡，这样游戏才能在没有说书人的情况下公平进行。

#### 验收标准

1. 当玩家查看游戏界面时，角色隐私保护系统应当只显示该玩家自己的角色卡正面
2. 当玩家查看其他玩家的座位时，角色隐私保护系统应当显示角色卡背面或隐藏状态
3. 当系统处理游戏逻辑时，隐形说书人应当访问所有角色信息但不向任何玩家展示
4. 当玩家尝试访问其他玩家的角色信息时，角色隐私保护系统应当阻止访问并记录尝试
5. 当游戏结束时，角色隐私保护系统应当解除限制并显示所有玩家的角色

### 需求 2: 玩家身份验证和座位认领

**用户故事:** 作为玩家，我希望能够认领一个座位并证明我的身份，这样系统才能知道应该向我展示哪个角色。

#### 验收标准

1. 当玩家加入房间时，玩家身份验证器应当提示玩家选择并认领一个空座位
2. 当玩家认领座位时，玩家身份验证器应当生成唯一的身份令牌并与该座位绑定
3. 当座位已被认领时，玩家身份验证器应当阻止其他玩家认领同一座位
4. 当玩家断线重连时，玩家身份验证器应当验证身份令牌并恢复玩家的座位
5. 当玩家身份验证失败时，玩家身份验证器应当拒绝访问并要求重新认领座位

### 需求 3: 游戏模式切换

**用户故事:** 作为房间创建者，我希望能够选择游戏模式，这样可以根据是否有说书人来决定使用哪种模式。

#### 验收标准

1. 当创建游戏房间时，游戏模式切换器应当提供"说书人模式"和"无说书人模式"两个选项
2. 当选择说书人模式时，游戏模式切换器应当保持当前的角色可见性设置（说书人可见所有角色）
3. 当选择无说书人模式时，游戏模式切换器应当启用角色隐私保护系统
4. 当游戏已经开始时，游戏模式切换器应当禁止切换游戏模式
5. 当游戏模式切换时，游戏模式切换器应当通知所有客户端更新UI显示

### 需求 4: 视角过滤和信息分级

**用户故事:** 作为系统，我需要能够区分公开信息和私密信息，这样才能正确地向不同玩家展示不同的内容。

#### 验收标准

1. 当同步游戏状态时，视角过滤器应当根据玩家身份过滤私密信息
2. 当玩家存活状态改变时，视角过滤器应当将此信息标记为公开信息并向所有玩家广播
3. 当投票结果产生时，视角过滤器应当将投票结果标记为公开信息并向所有玩家广播
4. 当夜间信息生成时，视角过滤器应当将信息标记为私密信息并只发送给相关玩家
5. 当玩家请求游戏状态时，视角过滤器应当返回该玩家视角下的过滤后状态

### 需求 5: 玩家视角UI

**用户故事:** 作为玩家，我希望看到清晰的游戏界面，这样我能够了解公开信息同时保护私密信息。

#### 验收标准

1. 当显示自己的座位时，玩家视角UI应当显示角色卡正面和完整的角色信息
2. 当显示其他玩家的座位时，玩家视角UI应当显示角色卡背面或占位符图像
3. 当显示公开信息时，玩家视角UI应当清晰标记哪些信息是所有人可见的
4. 当显示游戏阶段时，玩家视角UI应当显示当前是白天还是夜晚
5. 当显示玩家列表时，玩家视角UI应当显示每个玩家的存活状态和公开标记

### 需求 6: 自动化游戏流程集成

**用户故事:** 作为玩家，我希望无说书人模式能够无缝使用现有的自动化功能，这样游戏能够自动进行。

#### 验收标准

1. 当游戏开始时，自动化说书人系统应当在无说书人模式下正常分配角色
2. 当夜间阶段开始时，自动化说书人系统应当在后台处理所有夜间行动而不向玩家展示过程
3. 当白天阶段开始时，自动化说书人系统应当公布夜间死亡信息但不透露角色
4. 当投票进行时，自动化说书人系统应当管理投票流程并公布结果
5. 当游戏结束时，自动化说书人系统应当判断胜负并展示所有玩家的角色

### 需求 7: 安全性和防作弊

**用户故事:** 作为系统管理员，我希望系统能够防止玩家通过技术手段查看其他玩家的角色，这样游戏才能公平进行。

#### 验收标准

1. 当发送游戏状态到客户端时，角色隐私保护系统应当在服务器端过滤敏感信息
2. 当客户端请求角色信息时，角色隐私保护系统应当验证请求者的身份和权限
3. 当检测到异常访问尝试时，角色隐私保护系统应当记录日志并可选地断开连接
4. 当存储游戏状态时，角色隐私保护系统应当加密敏感信息
5. 当传输身份令牌时，角色隐私保护系统应当使用安全的加密通道

### 需求 8: 断线重连和状态恢复

**用户故事:** 作为玩家，我希望在断线后能够重新连接并恢复我的游戏状态，这样网络问题不会影响我的游戏体验。

#### 验收标准

1. 当玩家断线时，玩家身份验证器应当保留该玩家的座位和身份令牌
2. 当玩家重新连接时，玩家身份验证器应当验证身份令牌并恢复玩家的视角
3. 当恢复玩家状态时，视角过滤器应当发送该玩家视角下的完整游戏状态
4. 当玩家长时间断线时，玩家身份验证器应当在超时后释放座位
5. 当玩家尝试用过期令牌重连时，玩家身份验证器应当拒绝连接并要求重新认领座位

### 需求 9: 夜间信息私密传递

**用户故事:** 作为拥有信息类能力的玩家，我希望只有我能看到我获得的夜间信息，这样信息才有价值。

#### 验收标准

1. 当角色获得夜间信息时，视角过滤器应当只将信息发送给该角色的玩家
2. 当显示夜间信息时，玩家视角UI应当在私密区域显示信息
3. 当其他玩家查看游戏状态时，视角过滤器应当不包含其他玩家的夜间信息
4. 当玩家死亡后，视角过滤器应当继续保护该玩家已获得的夜间信息
5. 当游戏结束时，视角过滤器应当可选地公开所有夜间信息用于复盘

### 需求 10: 游戏模式配置持久化

**用户故事:** 作为房间创建者，我希望游戏模式设置能够被保存，这样下次创建房间时可以使用相同的设置。

#### 验收标准

1. 当保存游戏配置时，游戏模式切换器应当包含当前选择的游戏模式
2. 当加载游戏配置时，游戏模式切换器应当恢复之前保存的游戏模式
3. 当配置无效时，游戏模式切换器应当使用默认的说书人模式
4. 当导出游戏设置时，游戏模式切换器应当包含游戏模式在导出数据中
5. 当导入游戏设置时，游戏模式切换器应当验证游戏模式的有效性
