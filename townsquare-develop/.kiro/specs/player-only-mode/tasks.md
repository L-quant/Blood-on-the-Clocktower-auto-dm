# 实现计划: 无说书人自动化模式

## 概述

本实现计划将无说书人模式的角色隐私保护功能集成到现有的自动化说书人系统中。实现将分为核心隐私保护层、身份验证系统、UI适配和集成测试四个主要阶段。每个阶段都包含相应的属性测试和单元测试，确保隐私保护的正确性和安全性。

## 任务

- [x] 1. 创建核心隐私保护模块
  - 创建基础的隐私保护系统架构
  - 实现视角过滤器和游戏模式切换器
  - _需求: 1.1, 1.2, 1.3, 3.1, 3.2, 3.3_

  - [x] 1.1 创建RolePrivacySystem核心类
    - 在`src/automation/core/`目录下创建`RolePrivacySystem.js`
    - 实现初始化、启用/禁用隐私保护的基础方法
    - 实现游戏模式检查和状态过滤的入口方法
    - _需求: 1.1, 1.3_

  - [x] 1.2 实现PerspectiveFilter视角过滤器
    - 在`src/automation/core/`目录下创建`PerspectiveFilter.js`
    - 实现`filterGameState`方法，根据玩家ID过滤游戏状态
    - 实现`filterPlayer`方法，过滤单个玩家的角色信息
    - 实现`classifyInformation`方法，区分公开和私密信息
    - 实现`filterNightInformation`方法，过滤夜间信息
    - _需求: 1.1, 1.2, 4.1, 4.4, 4.5_

  - [ ]* 1.3 编写PerspectiveFilter的属性测试
    - **属性 1: 角色可见性隔离**
    - **验证需求: 1.1, 1.2, 5.1, 5.2**
    - 生成随机游戏状态和玩家身份
    - 验证每个玩家只能看到自己的角色
    - 验证其他玩家的角色被隐藏

  - [ ]* 1.4 编写PerspectiveFilter的属性测试
    - **属性 2: 系统全知但不泄露**
    - **验证需求: 1.3, 7.1**
    - 验证系统内部包含所有角色信息
    - 验证发送给客户端的数据不包含其他玩家角色

  - [x] 1.5 实现ModeSwitcher游戏模式切换器
    - 在`src/automation/core/`目录下创建`ModeSwitcher.js`
    - 实现`getCurrentMode`和`switchMode`方法
    - 实现`canSwitchMode`验证逻辑（游戏开始后禁止切换）
    - 实现`notifyModeChange`通知机制
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ]* 1.6 编写ModeSwitcher的属性测试
    - **属性 6: 游戏模式切换限制**
    - **验证需求: 3.4, 3.5**
    - 验证游戏开始后无法切换模式
    - 验证模式切换时通知所有客户端

- [x] 2. 实现玩家身份验证系统
  - 创建身份令牌管理和座位认领机制
  - 实现断线重连和令牌验证
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 8.1, 8.2, 8.4, 8.5_

  - [x] 2.1 创建PlayerAuthenticator身份验证器
    - 在`src/automation/core/`目录下创建`PlayerAuthenticator.js`
    - 实现`generatePlayerToken`方法，生成唯一令牌
    - 实现`validateToken`方法，验证令牌有效性
    - 实现`claimSeat`和`releaseSeat`方法
    - 实现`handleReconnection`断线重连逻辑
    - 实现`cleanupExpiredTokens`清理过期令牌
    - _需求: 2.2, 2.4, 2.5, 8.2, 8.5_

  - [ ]* 2.2 编写PlayerAuthenticator的属性测试
    - **属性 4: 座位认领唯一性**
    - **验证需求: 2.2, 2.3**
    - 生成随机座位认领请求
    - 验证每个座位只能被一个玩家认领
    - 验证每次认领生成唯一令牌

  - [ ]* 2.3 编写PlayerAuthenticator的属性测试
    - **属性 5: 令牌验证正确性**
    - **验证需求: 2.4, 2.5, 8.2, 8.5**
    - 生成有效、过期、无效的各种令牌
    - 验证令牌验证逻辑的正确性
    - 验证无效令牌被拒绝

  - [x] 2.4 创建SeatManager座位管理器
    - 在`src/automation/core/`目录下创建`SeatManager.js`
    - 实现`getAllSeats`和`getAvailableSeats`方法
    - 实现`bindPlayerToSeat`和`unbindPlayer`方法
    - 实现座位状态查询方法
    - _需求: 2.1, 2.3_

  - [ ]* 2.5 编写SeatManager的单元测试
    - 测试座位绑定和解绑
    - 测试座位状态查询
    - 测试边界条件（座位满员等）
    - _需求: 2.1, 2.3_

  - [ ]* 2.6 编写断线重连的属性测试
    - **属性 11: 断线重连恢复**
    - **验证需求: 8.1, 8.2, 8.3**
    - 模拟断线和重连场景
    - 验证令牌验证和座位恢复
    - 验证过滤后状态的正确性

  - [ ]* 2.7 编写超时处理的属性测试
    - **属性 12: 超时座位释放**
    - **验证需求: 8.4**
    - 模拟长时间断线
    - 验证座位释放和令牌失效

- [x] 3. 检查点 - 核心功能验证
  - 确保所有核心模块测试通过
  - 验证隐私保护和身份验证的基础功能
  - 如有问题请向用户询问

- [x] 4. 扩展Vuex Store添加隐私保护模块
  - 创建privacy模块管理隐私相关状态
  - 集成到现有的store架构中
  - _需求: 3.1, 3.2, 3.3, 10.1, 10.2_

  - [x] 4.1 创建privacy Vuex模块
    - 在`src/store/modules/`目录下创建`privacy.js`
    - 定义state: gameMode, myPlayerId, mySeatIndex, myToken等
    - 实现mutations: SET_GAME_MODE, SET_PLAYER_ID, SET_SEAT_INDEX等
    - 实现actions: claimSeat, releaseSeat, switchGameMode等
    - 实现getters: isPlayerOnlyMode, canSeeRole, getVisiblePlayers等
    - _需求: 3.1, 3.2, 3.3_

  - [x] 4.2 集成privacy模块到主store
    - 修改`src/store/index.js`，注册privacy模块
    - 确保与现有模块（session, players等）的兼容性
    - _需求: 3.1_

  - [ ]* 4.3 编写privacy模块的单元测试
    - 测试state mutations的正确性
    - 测试actions的异步逻辑
    - 测试getters的计算逻辑
    - _需求: 3.1, 3.2, 3.3_

- [x] 5. 扩展WebSocket通信支持隐私保护
  - 修改socket.js支持过滤后的状态同步
  - 添加座位认领和令牌验证的消息处理
  - _需求: 2.1, 2.2, 4.1, 4.2, 4.3, 7.1_

  - [x] 5.1 扩展LiveSession类支持隐私保护
    - 修改`src/store/socket.js`中的LiveSession类
    - 添加`claimSeatWithToken`方法处理座位认领
    - 修改`sendGamestate`方法，在无说书人模式下过滤状态
    - 添加`_handleSeatClaim`处理座位认领消息
    - 添加`_handleTokenValidation`处理令牌验证
    - _需求: 2.1, 2.2, 4.1, 7.1_

  - [x] 5.2 添加新的WebSocket消息类型
    - 添加"claimSeat"消息类型处理座位认领
    - 添加"validateToken"消息类型处理令牌验证
    - 添加"modeSwitch"消息类型处理模式切换通知
    - 修改"gs"（gamestate）消息，支持过滤后的状态
    - _需求: 2.1, 2.2, 3.5, 4.1_

  - [ ]* 5.3 编写WebSocket通信的属性测试
    - **属性 7: 视角过滤一致性**
    - **验证需求: 4.1, 4.5, 8.3**
    - 模拟状态同步请求
    - 验证返回的状态正确过滤
    - 验证私密信息不泄露

  - [ ]* 5.4 编写公开信息广播的属性测试
    - **属性 8: 公开信息广播**
    - **验证需求: 4.2, 4.3, 5.5**
    - 模拟公开信息变化
    - 验证所有玩家收到相同的公开信息

- [x] 6. 修改Player组件支持角色隐私显示
  - 修改Player.vue根据玩家身份显示角色
  - 添加角色卡背面显示逻辑
  - _需求: 1.1, 1.2, 5.1, 5.2, 5.4, 5.5_

  - [x] 6.1 修改Player.vue组件
    - 修改`src/components/Player.vue`
    - 添加computed属性`isMyPlayer`判断是否是自己
    - 添加computed属性`shouldShowRole`判断是否显示角色
    - 修改Token组件的显示逻辑，根据`shouldShowRole`显示正面或背面
    - 添加角色卡背面的CSS样式
    - _需求: 1.1, 1.2, 5.1, 5.2_

  - [x] 6.2 添加座位认领UI
    - 在Player组件的菜单中添加"认领座位"选项
    - 实现`claimSeat`方法调用Vuex action
    - 显示座位认领状态（已认领、可认领、被占用）
    - _需求: 2.1_

  - [x] 6.3 添加游戏阶段和公开信息显示
    - 修改TownInfo组件显示当前游戏阶段
    - 确保公开信息（存活状态、投票结果）对所有玩家可见
    - _需求: 5.4, 5.5_

  - [ ]* 6.4 编写Player组件的单元测试
    - 测试角色可见性逻辑
    - 测试座位认领UI交互
    - 测试不同游戏模式下的显示
    - _需求: 1.1, 1.2, 5.1, 5.2_

- [x] 7. 创建游戏模式选择UI
  - 添加模式选择界面
  - 集成到游戏创建流程
  - _需求: 3.1, 3.2, 3.3_

  - [x] 7.1 创建ModeSelector组件
    - 在`src/components/modals/`目录下创建`ModeSelector.vue`
    - 提供"说书人模式"和"无说书人模式"两个选项
    - 显示每种模式的说明
    - 实现模式选择逻辑
    - _需求: 3.1_

  - [x] 7.2 集成ModeSelector到游戏创建流程
    - 修改Menu组件，添加模式选择入口
    - 在游戏开始前显示模式选择界面
    - 保存选择的模式到Vuex store
    - _需求: 3.1, 3.2, 3.3_

  - [ ]* 7.3 编写ModeSelector的单元测试
    - 测试模式选择UI
    - 测试模式切换逻辑
    - 测试游戏开始后禁止切换
    - _需求: 3.1, 3.4_

- [x] 8. 检查点 - UI和通信功能验证
  - 确保UI正确显示角色隐私
  - 验证WebSocket通信正确过滤状态
  - 测试座位认领和模式切换功能
  - 如有问题请向用户询问

- [x] 9. 集成自动化说书人系统
  - 修改自动化系统支持无说书人模式
  - 确保游戏流程在隐私保护下正常工作
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 9.1 修改AutomatedStorytellerSystem支持隐私保护
    - 修改`src/automation/core/AutomatedStorytellerSystem.js`
    - 在初始化时检查游戏模式
    - 在无说书人模式下启用RolePrivacySystem
    - 修改状态同步逻辑，使用PerspectiveFilter过滤状态
    - _需求: 6.1_

  - [x] 9.2 修改RoleAssigner支持无说书人模式
    - 修改`src/automation/core/RoleAssigner.js`
    - 在无说书人模式下，角色分配后不向玩家展示其他角色
    - 使用PerspectiveFilter过滤分配结果
    - _需求: 6.1_

  - [x] 9.3 修改NightActionProcessor支持隐私保护
    - 修改`src/automation/core/NightActionProcessor.js`
    - 在处理夜间行动时，不向玩家展示过程细节
    - 只向相关玩家发送夜间信息
    - _需求: 6.2, 9.1_

  - [x] 9.4 修改VotingManager支持隐私保护
    - 修改`src/automation/core/VotingManager.js`
    - 在白天阶段公布死亡信息但不透露角色
    - 确保投票流程在无说书人模式下正常工作
    - _需求: 6.3, 6.4_

  - [ ]* 9.5 编写自动化系统集成的属性测试
    - **属性 10: 自动化系统集成**
    - **验证需求: 6.1, 6.2, 6.3, 6.4**
    - 模拟完整游戏流程
    - 验证角色分配、夜间行动、投票在无说书人模式下正常工作
    - 验证不泄露其他玩家角色信息

- [x] 10. 实现游戏结束时的角色公开
  - 修改胜负判断器，游戏结束时解除隐私保护
  - 显示所有玩家的角色
  - _需求: 1.5, 6.5_

  - [x] 10.1 修改VictoryConditionChecker支持角色公开
    - 修改`src/automation/core/VictoryConditionChecker.js`
    - 在游戏结束时调用RolePrivacySystem解除隐私保护
    - 生成包含所有角色的游戏报告
    - _需求: 1.5, 6.5_

  - [x] 10.2 修改UI显示游戏结束时的所有角色
    - 修改Player组件，游戏结束时显示所有角色正面
    - 添加游戏结束动画和角色展示
    - _需求: 1.5_

  - [ ]* 10.3 编写游戏结束的单元测试
    - **属性 15: 游戏结束角色公开**
    - **验证需求: 1.5, 6.5**
    - 测试游戏结束时所有角色可见
    - 测试隐私保护解除

- [x] 11. 实现安全性和错误处理
  - 添加访问控制和日志记录
  - 实现错误恢复机制
  - _需求: 1.4, 7.2, 7.3, 7.4_

  - [x] 11.1 实现访问控制和日志记录
    - 在RolePrivacySystem中添加`logAccessAttempt`方法
    - 记录所有角色访问尝试
    - 实现异常访问检测和阻止
    - _需求: 1.4, 7.2, 7.3_

  - [ ]* 11.2 编写访问控制的属性测试
    - **属性 3: 非法访问阻止**
    - **验证需求: 1.4, 7.2, 7.3**
    - 模拟非法访问请求
    - 验证系统拒绝访问并记录

  - [x] 11.3 实现敏感信息加密
    - 在存储游戏状态时加密角色信息
    - 实现简单的加密/解密工具
    - _需求: 7.4_

  - [ ]* 11.4 编写加密功能的单元测试
    - 测试加密和解密的正确性
    - 测试存储的数据是加密的
    - _需求: 7.4_

- [x] 12. 实现配置持久化
  - 支持游戏模式配置的保存和加载
  - 实现配置验证和默认值
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

  - [x] 12.1 扩展ConfigurationManager支持游戏模式
    - 修改`src/automation/core/ConfigurationManager.js`
    - 在配置中添加gameMode字段
    - 实现配置的保存和加载
    - 实现配置验证逻辑
    - _需求: 10.1, 10.2, 10.3, 10.5_

  - [ ]* 12.2 编写配置持久化的属性测试
    - **属性 13: 配置往返一致性**
    - **验证需求: 10.1, 10.2, 10.4**
    - 生成随机配置
    - 验证保存后加载产生等价配置
    - 验证游戏模式正确恢复

  - [ ]* 12.3 编写配置验证的属性测试
    - **属性 14: 配置验证和默认值**
    - **验证需求: 10.3, 10.5**
    - 使用无效配置测试
    - 验证使用默认值
    - 验证导入配置的验证逻辑

- [x] 13. 实现私密信息隔离
  - 确保夜间信息只发送给相关玩家
  - 实现私密信息的完整保护
  - _需求: 4.4, 9.1, 9.2, 9.3, 9.4, 9.5_

  - [x] 13.1 实现夜间信息过滤
    - 在PerspectiveFilter中完善`filterNightInformation`方法
    - 确保夜间信息只包含给当前玩家的信息
    - 实现死亡后的信息保护
    - _需求: 9.1, 9.3, 9.4_

  - [x] 13.2 修改UI显示私密信息
    - 在Player组件或TownInfo中添加私密信息显示区域
    - 只显示当前玩家的夜间信息
    - _需求: 9.2_

  - [ ]* 13.3 编写私密信息隔离的属性测试
    - **属性 9: 私密信息隔离**
    - **验证需求: 4.4, 9.1, 9.3, 9.4**
    - 生成随机夜间信息
    - 验证只发送给相关玩家
    - 验证其他玩家无法访问
    - 验证死亡后信息仍然私密

  - [ ]* 13.4 编写游戏结束信息公开的单元测试
    - 测试游戏结束时可选地公开夜间信息
    - _需求: 9.5_

- [x] 14. 检查点 - 完整功能验证
  - 运行所有测试确保通过
  - 进行端到端测试验证完整游戏流程
  - 验证隐私保护在各种场景下的正确性
  - 如有问题请向用户询问

- [x] 15. 集成测试和文档
  - 编写集成测试验证完整功能
  - 更新文档说明新功能
  - _需求: 所有需求_

  - [ ]* 15.1 编写端到端集成测试
    - 测试完整的游戏流程（创建房间→认领座位→游戏进行→游戏结束）
    - 测试多玩家场景下的隐私保护
    - 测试断线重连场景
    - 测试模式切换场景
    - _需求: 所有需求_

  - [x] 15.2 更新README文档
    - 在`src/automation/README.md`中添加无说书人模式的说明
    - 说明如何使用无说书人模式
    - 说明座位认领和身份验证机制
    - 添加使用示例和注意事项
    - _需求: 所有需求_

  - [x] 15.3 创建用户指南
    - 创建`PLAYER_ONLY_MODE_GUIDE.md`用户指南
    - 说明无说书人模式的特点和使用方法
    - 提供常见问题解答
    - _需求: 所有需求_

- [x] 16. 最终检查点 - 确保所有测试通过
  - 运行完整的测试套件
  - 确保代码覆盖率达标
  - 验证所有正确性属性
  - 向用户确认功能完整性

## 注意事项

- 标记为`*`的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求编号，确保可追溯性
- 检查点任务确保增量验证，及时发现问题
- 属性测试验证通用正确性，单元测试验证具体场景
- 所有核心隐私保护逻辑都有对应的属性测试
